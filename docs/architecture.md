# Архитектура системы Xray VLESS + Reality

## Общая схема архитектуры

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Load Balancer │────│  Xray Server 1  │────│   Monitoring    │
│   (Nginx/HAProxy)│    │  (VLESS+Reality)│    │  (Prometheus)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │              ┌─────────────────┐              │
         └──────────────│  Xray Server 2  │──────────────┘
                        │  (VLESS+Reality)│
                        └─────────────────┘
                                 │
                        ┌─────────────────┐
                        │  Xray Server 3  │
                        │  (VLESS+Reality)│
                        └─────────────────┘
                                 │
         ┌─────────────────────────────────────────────┐
         │              Backend Services               │
         │  ┌─────────┐ ┌─────────┐ ┌─────────┐      │
         │  │Telegram │ │Payment  │ │User     │      │
         │  │Bot      │ │Service  │ │Service  │      │
         │  └─────────┘ └─────────┘ └─────────┘      │
         └─────────────────────────────────────────────┘
                                 │
         ┌─────────────────────────────────────────────┐
         │              Data Layer                     │
         │  ┌─────────┐ ┌─────────┐ ┌─────────┐      │
         │  │PostgreSQL│ │Redis   │ │File     │      │
         │  │Cluster  │ │Cluster  │ │Storage  │      │
         │  └─────────┘ └─────────┘ └─────────┘      │
         └─────────────────────────────────────────────┘
```

## Компоненты системы

### 1. Load Balancer (Nginx/HAProxy)
- Распределение нагрузки между Xray серверами
- Health checks для автоматического исключения неработающих серверов
- SSL termination
- Rate limiting для защиты от DDoS

### 2. Xray Core Servers
- Минимум 3 сервера для отказоустойчивости
- VLESS + Reality протоколы
- Автоматическое обновление SNI конфигураций
- Мониторинг производительности

### 3. Backend Services

#### Telegram Bot Service
- Регистрация пользователей
- Генерация конфигураций
- Управление подписками
- Реферальная система

#### Payment Service
- Интеграция с YooKassa, Robokassa
- Криптовалютные платежи
- Обработка webhook'ов
- Управление подписками

#### User Service
- Управление пользователями
- Лимиты по устройствам
- Реферальная программа
- Аналитика

### 4. Data Layer

#### PostgreSQL Cluster
- Основная база данных
- Репликация для отказоустойчивости
- Backup стратегия

#### Redis Cluster
- Кэширование конфигураций
- Сессии пользователей
- Rate limiting

#### File Storage
- Конфигурационные файлы
- Логи
- Backup'ы

### 5. Monitoring Stack
- Prometheus - сбор метрик
- Grafana - визуализация
- AlertManager - уведомления
- ELK Stack - логирование

## Масштабирование

### Горизонтальное масштабирование
- Добавление новых Xray серверов
- Автоматическое распределение пользователей
- Load balancing

### Вертикальное масштабирование
- Увеличение ресурсов серверов
- Оптимизация конфигураций
- Кэширование

## Безопасность

### Защита от DDoS
- Rate limiting
- Cloudflare защита
- Автоматическое блокирование подозрительного трафика

### Шифрование
- TLS для всех соединений
- Шифрование базы данных
- Безопасное хранение ключей

### Мониторинг безопасности
- Логирование всех действий
- Анализ подозрительной активности
- Автоматические алерты
